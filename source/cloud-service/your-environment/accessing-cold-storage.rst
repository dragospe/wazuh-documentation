.. Copyright (C) 2020 Wazuh, Inc.

.. _cloud_your_environment_accessing_cold_storage:

.. meta::
  :description: Learn about acessing your environment's cold storage

Accessing cold storage
======================

The cold storage is located in an AWS S3 bucket. Using the Wazuh Cloud API, you can generate a temporary AWS token that allows you to download your data using the Amazon S3 REST API.

Next, the process of manually accessing cold storage is going to be described, but a script is provided on the `Automation of the access`_ section to make this configuration automatically. Take a look at the `Filename format`_ section to understand how your information is stored.

1. **Authentication**

:ref:`Generate your API key <cloud_apis_auth>`.

2. **Getting AWS token**

Use the /storage/token of the :cloud-api-ref:`Wazuh Cloud API <tag/storage>` to get the AWS token.


3. **Using your AWS credentials**

Use the AWS-CLI to download your cold storage.

Create a new profile with the credentials generated by the previous request. Edit ``~/.aws/credentials``:

.. code-block:: console
   
   [wazuh_cloud_storage]
   aws_access_key_id = 1
   aws_secret_access_key = 2
   aws_session_token = 3

Then, test your credentials:

.. code-block:: console
   
   $ aws --profile wazuh_cloud_storage --region <region> s3 ls cloud-cold-<region>/<cloud_id>/

Mind replacing ``<cloud_id>`` with the environment's Cloud ID and ``<region>`` with your region.

Filename format
---------------

Cold storage files are stored according to the following format:

``wazuh-cloud-cold-<region>/<cloud_id>/<category>[/<subcategory>]/<year>/<month>/<day>``

And each file will have the following name:

``<cloud_id>_<category>[_<subcategory>]_<YYYYMMDDTHHmm>_<UniqueString>.<format>``

Where each of those fields have the following meaning:

- ``<region>``:  It is the region where the subscription is located.

- ``<cloud_id>``: Environment's Cloud ID.

- ``<category>``: Either "output" or "config".

- ``<subcategory>``: Only used by the output category, contains "alerts", "archives" or "firewall" files.
  
- ``<year>``: Year when the message was received.
  
- ``<month>``: Month when the message was received.
  
- ``<day>``: Day when the message was received.
  
- ``<YYYYMMDDTHHmm>``: Digits of the year, month, day, hour, and minute when the file was delivered. Hours are in 24-hour format and in UTC. A log file delivered at a specific time can contain records written at any point before that time.
  
- ``<UniqueString>``: The 16-character UniqueString component of the file name prevents overwriting files. It has no meaning, and log processing software should ignore it.
  
- ``<format>``: It is the encoding of the file. It could be either "json.gz", which is a JSON text file in compressed gzip format, or "tar.gz".



Automation of the access
------------------------

We  provide `an script <https://wazuh-cloud-tools.s3-us-west-1.amazonaws.com/examples/wcloud-cold-storage.py>`_ which downloads the data from S3 and auto refreshes the AWS session. This can be used as an example to learn how to automatize this process.

Example of use:

.. code-block::

   $ wcloud-cold-storage.py --subscription <cloud_id> --private_key /home/cloud/my_key --output_path /home/cloud/data --region <region> --start_date 2020-04-23 --end_date 2020-04-23

Mind replacing ``<cloud_id>`` with your Cloud ID, ``<region>`` with your region and fitting the rest of the arguments.
